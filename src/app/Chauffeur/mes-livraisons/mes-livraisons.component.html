<div class="chauffeur-livraisons-container">
  <div class="header-section">
    <h2>ğŸšš Mes livraisons</h2>
    <div class="filters">
      <input 
        type="text" 
        placeholder="Rechercher..." 
        class="search-input"
        [(ngModel)]="searchTerm"
        (input)="applyFilters()" />
      
      <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="status-filter">
        <option value="ALL">Tous les statuts</option>
        <option [value]="DeliveryStatus.PENDING">En attente</option>
        <option [value]="DeliveryStatus.ACCEPTED">AcceptÃ©e</option>
        <option [value]="DeliveryStatus.IN_TRANSIT">En transit</option>
        <option [value]="DeliveryStatus.DRIVER_TRANSFER">TransfÃ©rÃ©e</option>
        <option [value]="DeliveryStatus.DELIVERED">LivrÃ©e</option>
        <option [value]="DeliveryStatus.CANCELED">AnnulÃ©e</option>
      </select>
      
      <button class="btn-map-toggle" (click)="toggleMap()">
        {{ showMap ? 'ğŸ“‹ Masquer la carte' : 'ğŸ—ºï¸ Voir sur la carte' }}
      </button>
    </div>
  </div>

  <div class="success" *ngIf="successMessage">{{ successMessage }}</div>
  <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
  <div class="loading" *ngIf="loading">Chargement...</div>

  <!-- Map Section -->
  <div class="map-section" *ngIf="showMap">
    <div id="driver-map" class="map-container"></div>
    <div class="map-info">
      <h4>ğŸ—ºï¸ Carte des livraisons</h4>
      <p>Visualisez toutes vos livraisons sur la carte avec leurs routes</p>
      <div class="map-legend">
        <div class="legend-item">
          <span class="legend-color" style="background-color: #007bff;"></span>
          <span>En transit / AcceptÃ©e</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #28a745;"></span>
          <span>LivrÃ©e</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #ffc107;"></span>
          <span>TransfÃ©rÃ©e</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #6c757d;"></span>
          <span>En attente</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #dc3545;"></span>
          <span>AnnulÃ©e</span>
        </div>
      </div>
    </div>
  </div>

  <div class="livraisons-grid" *ngIf="!loading && filteredLivraisons.length > 0">
    <div class="livraison-card" *ngFor="let livraison of filteredLivraisons">
      <div class="card-header">
        <span class="livraison-id">#{{ livraison.id }}</span>
        <span class="status status-{{ getStatusClass(livraison.status) }}">
          {{ getStatusLabel(livraison.status) }}
        </span>
      </div>

      <div class="card-body">
        <p class="description">{{ livraison.description }}</p>
        
        <div class="route-section">
          <div class="route-item">
            <span class="route-icon">ğŸ“</span>
            <div class="route-details">
              <strong>DÃ©part:</strong>
              <span>{{ livraison.departureAddress.city }} - {{ livraison.departureAddress.region }}</span>
            </div>
          </div>
          
          <div class="route-arrow">â†’</div>
          
          <div class="route-item">
            <span class="route-icon">ğŸ¯</span>
            <div class="route-details">
              <strong>ArrivÃ©e:</strong>
              <span>{{ livraison.arrivalAddress.city }} - {{ livraison.arrivalAddress.region }}</span>
            </div>
          </div>
        </div>

        <div class="meta-info">
          <span class="type-badge type-{{ livraison.type.toLowerCase() }}">
            {{ getTypeLabel(livraison.type) }}
          </span>
          <span class="date">{{ formatDate(livraison.createdAt) }}</span>
        </div>

        <div class="station-info" *ngIf="livraison.station">
          <span class="station-badge">ğŸ“ Station: {{ livraison.station.name }}</span>
        </div>
      </div>

      <div class="card-footer" *ngIf="canUpdateStatus(livraison.status)">
        <div class="action-buttons">
          <button 
            class="btn-status btn-map-view" 
            (click)="selectDeliveryOnMap(livraison)"
            title="Voir sur la carte">
            ğŸ—ºï¸ Voir sur la carte
          </button>
          <button 
            class="btn-status btn-delivered" 
            (click)="changerStatut(livraison.id!, DeliveryStatus.DELIVERED)">
            âœ… Marquer livrÃ©e
          </button>
          <button 
            class="btn-status btn-transit" 
            (click)="changerStatut(livraison.id!, DeliveryStatus.IN_TRANSIT)">
            ğŸšš En transit
          </button>
          <button 
            class="btn-status btn-transfer" 
            (click)="openTransferForm(livraison)">
            ğŸ“ TransfÃ©rer Ã  station
          </button>
          <button 
            class="btn-status btn-cancel" 
            (click)="changerStatut(livraison.id!, DeliveryStatus.CANCELED)">
            âŒ Annuler
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="no-data" *ngIf="!loading && filteredLivraisons.length === 0">
    <p *ngIf="mesLivraisons.length === 0">
      Aucune livraison assignÃ©e pour le moment.
    </p>
    <p *ngIf="mesLivraisons.length > 0 && filteredLivraisons.length === 0">
      Aucune livraison ne correspond Ã  vos critÃ¨res de recherche.
    </p>
  </div>

  <div class="transfer-popup" *ngIf="showTransferForm">
    <div class="popup-content">
      <h3>TransfÃ©rer vers une station</h3>
      <p><strong>Livraison:</strong> {{ selectedLivraison?.description }}</p>
      <p><strong>ID:</strong> #{{ selectedLivraison?.id }}</p>
      
      <label for="stationSelect">SÃ©lectionner une station:</label>
      <select 
        id="stationSelect"
        [(ngModel)]="selectedStationId" 
        name="stationId" 
        required>
        <option [value]="0">-- SÃ©lectionner une station --</option>
        <option *ngFor="let station of stations" [value]="station.id">
          {{ station.name }} - {{ station.region }}
        </option>
      </select>

      <div class="form-actions">
        <button 
          class="btn-save" 
          (click)="transferToStation()" 
          [disabled]="!selectedStationId || selectedStationId === 0">
          TransfÃ©rer
        </button>
        <button class="btn-cancel" (click)="cancelTransfer()">Annuler</button>
      </div>
    </div>
  </div>
</div>
